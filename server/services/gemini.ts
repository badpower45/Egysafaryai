import { GoogleGenAI } from "@google/genai";

const ai = new GoogleGenAI({ 
  apiKey: process.env.GEMINI_API_KEY || "AIzaSyAwerw8ya9G6jdUwx8rRDluz9GQfkLENw8" 
});

export interface ChatMessage {
  role: "user" | "assistant";
  content: string;
  timestamp: number;
}

export async function getChatResponse(message: string, chatHistory: ChatMessage[] = []): Promise<string> {
  try {
    // Create context for Port Said tourism in Egyptian dialect with location links
    const systemContext = `Ø¥Ù†Øª Ø¥ÙŠØ¬ÙŠ Ø³ÙØ§Ø±ÙŠ AIØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø³ÙØ± Ø´Ø§Ø·Ø± Ù…ØªØ®ØµØµ ÙÙŠ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ØŒ Ù…ØµØ±. 
    Ø¨ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø§ÙØ±ÙŠÙ† ÙŠØ®Ø·Ø·ÙˆØ§ Ø±Ø­Ù„Ø§ØªÙ‡Ù… ÙˆØ¨ØªÙ‚ÙˆÙ„Ù‡Ù… Ø¹Ù„Ù‰ Ø£Ø­Ø³Ù† Ù…Ø·Ø§Ø¹Ù… ÙˆÙ…Ø¹Ø§Ù„Ù… ÙˆØ£Ù†Ø´Ø·Ø© ÙÙŠ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯.
    
    Ø§Ù„Ù…Ø·Ø§Ø¹Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯:
    - Ø£ÙƒÙ„ Ø¨Ø­Ø±ÙŠ: Ø£Ø³Ù…Ø§Ùƒ Ø³ÙŠØªÙŠØŒ Ø§Ù„Ø¨Ù„Ø¯ÙŠ ÙŠÙˆÙƒÙ„ØŒ Ø¨ÙŠØªØ§Ø¹ Ø³Ù…ÙƒØŒ Ø§Ø¨Ù† Ø­Ù…ÙŠØ¯ÙˆØŒ Ù…Ù„ÙˆÙƒ Ø§Ù„Ø³Ù…ÙƒØŒ Ø¨ÙˆØ±ØªÙˆ ÙÙŠØ´
    - Ø£ÙƒÙ„ Ø´Ø±Ù‚ÙŠ: Ø±Ø§Ø´Ø¯ Ø§Ù„Ø³ÙˆØ±ÙŠØŒ Ø³ÙŠØªÙŠ ÙƒØ±ÙŠØ¨ØŒ Ø¨ÙŠØªØ²Ø§ Ø±ÙˆÙƒØ§
    - Ù…Ø¹Ø¬Ù†Ø§Øª: ØªØ§Ù…Ø± Ø§Ù„Ø£Ø³Ø·Ù‰ØŒ Ø¹Ø¨Ø¯Ù‡ Ø³Ø§Ù„Ù…
    
    Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:
    - Ù…Ø­Ù„Ø§Øª ÙˆÙ„Ø§Ø¯ÙŠ: ØªÙˆØ¨ Ø¬ÙŠÙ†Ø² (ØªÙ‚ÙŠÙŠÙ… 4.8)ØŒ Ø£Ø¨Ùˆ Ø¹Ù„Ø§Ø¡ Ø£ÙƒØªÙŠÙ (ØªÙ‚ÙŠÙŠÙ… 4.5)
    - Ù…Ø­Ù„Ø§Øª Ø¨Ù†Ø§ØªÙŠ: Ù†ØªØ³ Ø¬ÙŠÙ†Ø² (ØªÙ‚ÙŠÙŠÙ… 4.6)ØŒ Ø¨Ù†Ø¯Ù‚ Ø¬ÙŠÙ†Ø² (ØªÙ‚ÙŠÙŠÙ… 4.7)ØŒ ØªÙˆØ¨ Ø¬ÙŠØ±Ù„ (ØªÙ‚ÙŠÙŠÙ… 4.7)ØŒ Ø¯ÙŠØ¬Ø§ Ø³ØªÙˆØ± (ØªÙ‚ÙŠÙŠÙ… 4.5)
    
    Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù„ÙŠ ØªØ³ØªØ§Ù‡Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©:
    - Ø£Ù…Ø§ÙƒÙ† ØªØ§Ø±ÙŠØ®ÙŠØ©: Ø§Ù„Ù…Ù†Ø§Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŒ ØªÙ…Ø«Ø§Ù„ ÙØ±Ø¯ÙŠÙ†Ø§Ù†Ø¯ Ø¯ÙŠ Ù„ÙŠØ³Ø¨Ø³ØŒ Ù…ÙŠØ¯Ø§Ù† Ù…ØµØ±ØŒ Ø³ÙŠÙ…ÙˆÙ† Ø£Ø±Ø²ØªØŒ Ø§Ù„Ø¨ÙŠØª Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠØŒ Ø§Ù„Ù‚Ù†ØµÙ„ÙŠØ© Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠØ©
    - Ø£Ù…Ø§ÙƒÙ† Ø¯ÙŠÙ†ÙŠØ©: Ø§Ù„Ù…Ø³Ø¬Ø¯ Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠ
    - Ø­Ø¯Ø§Ø¦Ù‚: Ø­Ø¯ÙŠÙ‚Ø© ÙØ±ÙŠØ§Ù„ØŒ Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ù…Ù†ØªØ²Ù‡ØŒ ÙƒÙˆØ±Ù†ÙŠØ´ Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯
    - Ù…ØªØ§Ø­Ù: Ù…ØªØ­Ù Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠ
    - Ø´ÙˆØ§Ø·Ø¦ Ø­Ù„ÙˆØ© Ù„Ù„ÙØ³Ø­Ø©
    
    Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: Ù„Ù…Ø§ ØªÙ‚ÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙƒØ§Ù†ØŒ Ù…Ø·Ø¹Ù…ØŒ Ø£Ùˆ Ù…Ø¹Ù„Ù…ØŒ Ø§Ø¯ÙŠÙ„Ù‡ Ù„ÙŠÙ†Ùƒ Ø®Ø±Ø§ÙŠØ· Ø¬ÙˆØ¬Ù„ Ø¹Ø´Ø§Ù† Ø§Ù„Ù†Ø§Ø³ ØªØ¹Ø±Ù ØªØ±ÙˆØ­. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙˆØ±Ù…Ø§Øª Ø¯Ù‡:
    
    ðŸ—ºï¸ **Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù†**: [Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø®Ø±Ø§ÙŠØ· Ø¬ÙˆØ¬Ù„](https://www.google.com/maps/search/[Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†]+Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯+Ù…ØµØ±)
    
    Ù…Ø«Ø§Ù„: ðŸ—ºï¸ **Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù†**: [Ø­Ø¯ÙŠÙ‚Ø© ÙØ±ÙŠØ§Ù„ Ø¹Ù„Ù‰ Ø®Ø±Ø§ÙŠØ· Ø¬ÙˆØ¬Ù„](https://www.google.com/maps/search/Ø­Ø¯ÙŠÙ‚Ø©+ÙØ±ÙŠØ§Ù„+Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯+Ù…ØµØ±)
    
    Ø§ØªÙƒÙ„Ù… Ø¨Ù„Ù‡Ø¬Ø© Ù…ØµØ±ÙŠØ© ÙˆØ¯ÙˆØ¯Ø© ÙˆØ¥Ø¯ÙŠÙ„Ù‡Ù… Ù†ØµØ§ÙŠØ­ Ù…Ø­Ø¯Ø¯Ø© Ø¹Ù„Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ù„ÙŠ Ù‡Ù…Ø§ Ø¹Ø§ÙŠØ²ÙŠÙ†Ù‡. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø³ÙŠØ§Ø­Ø© Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯ Ø¨Ø³. Ø±Ø¯ Ø¨Ø§Ù„Ù…ØµØ±ÙŠ Ø¹Ù„Ø·ÙˆÙ„. ÙˆÙ…ØªÙ†Ø³Ø§Ø´ ØªØ¯ÙŠÙ„Ù‡Ù… Ù„ÙŠÙ†Ùƒ Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù† Ø¯Ø§ÙŠÙ…Ø§Ù‹.`;

    // Format conversation history
    const conversationHistory = chatHistory.map(msg => ({
      role: msg.role === "user" ? "user" : "model" as const,
      parts: [{ text: msg.content }]
    }));

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: [
        ...conversationHistory,
        {
          role: "user",
          parts: [{ text: `${systemContext}\n\nUser question: ${message}` }]
        }
      ],
    });

    return response.text || "I'm sorry, I couldn't process your request. Please try asking again.";
  } catch (error) {
    console.error("Gemini API error:", error);
    throw new Error("Sorry, I'm having trouble connecting right now. Please try again in a moment.");
  }
}
